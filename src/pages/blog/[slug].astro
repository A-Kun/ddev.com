---
import {
  getAllBlogPosts,
  getBlogPostBySlug,
  formatDate,
  getReadTime,
} from "../../lib/api"
import Layout from "../../layouts/Layout.astro"
import PostBody from "../../components/PostBody.astro"
import Heading from "../../components/Heading.astro"
import BlogPostFooter from "../../components/BlogPostFooter.astro"

/**
 * Tell Astro to build routes for individual blog posts.
 * https://docs.astro.build/en/reference/api-reference/#getstaticpaths
 */
export async function getStaticPaths() {
  const pagesWithSlugs = await getAllBlogPosts()
  return pagesWithSlugs.edges.map(({ node }) => {
    return {
      params: { slug: node.slug },
    }
  })
}

const { slug } = Astro.params
const page = await getBlogPostBySlug(slug)
const title = page.title
const author = page.author.node
---

<Layout title={title}>
  <main class="max-w-4xl mx-auto mb-24">
    <Heading
      title={title}
      date={formatDate(page.date, { month: "long" })}
      author={author.name}
      authorUrl={`/blog/author/${author.slug}`}
      authorAvatar={author.avatar.url}
      readTime={getReadTime(page.content)}
    />
    <div class="flex">
      <div class="w-2/3">
        <PostBody>
          <div set:html={page.content} />
        </PostBody>
      </div>
      <div class="w-1/3 pl-24 mt-6">
        {
          page.categories.nodes.length && (
            <>
              <span class="font-mono text-sm block text-navy-300 tracking-wider">
                Posted In
              </span>
              <ul class="mt-1">
                {page.categories.nodes.map((node) => (
                  <li class="my-1">
                    <a href={`/blog/category/${node.slug}`} class="font-bold">
                      {node.name}
                    </a>
                  </li>
                ))}
              </ul>
            </>
          )
        }
      </div>
    </div>
  </main>
  <BlogPostFooter slug={slug} />
</Layout>
